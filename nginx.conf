{% set root_path = salt['pillar.get']('nas:root_path') -%}
{% set server_params = salt['pillar.get']('nas:http')|default -%}
server {
	listen 80{% if server_params['default']|default(True) %} default_server{% endif %};
	listen [::]:80{% if server_params['default']|default(True) %} default_server{% endif %};

	{% if server_params['server_name']|default %}
	server_name {{ server_params['server_name'] }} {% if server_params['default']|default(True) %}""{% endif %};
	{% endif %}

	autoindex on;
	autoindex_exact_size off;
	try_files $uri $uri/ =404;

	location = / {
		root {{ root_path }};
	}

	{%- for path, config in salt['pillar.get']('nas:paths', []).iteritems() %}
	{%- if 'http' in config %}
	location /{{ path.strip('/') }} {
		alias {{ root_path }}/{{ path }};

		{%- if 'auth' in config['http'] %}
		auth_basic "{{ config['http']['auth'] }}";
		auth_basic_user_file auth/{{ path|replace('/', '-') }}.htpasswd;
		{%- endif %}
	}
	{%- endif %}
	{% endfor %}
}
